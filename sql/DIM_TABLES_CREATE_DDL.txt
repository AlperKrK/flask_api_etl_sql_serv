/* ###### 2. DIMENSION TABLOLARI OLUSTURULUR ##### */
/*###  3 >>>> DIM_EXCHANGE_RATE ###*/
--KUR DONUSUMU ICIN DIM_EXCHANGE_RATE TABLOSUNU APIDEN GELEN KURLARA GORE MANUEL OLUSTURDUM,GERCEKTE TCMB.GOV.TR DEN ALINIR
CREATE TABLE DBO.DIM_EXCHANGE_RATE
(DATEID NVARCHAR(8),
 CURRENCY_CODE NVARCHAR(20),
 TL_EXCHANGE_RATE DECIMAL(10,4),
 USD_EXCHANGE_RATE DECIMAL(10,4),
 ETL_DATE DATETIME
)


;
INSERT INTO DBO.DIM_EXCHANGE_RATE
SELECT HH.*,GETDATE() AS ETL_DATE
FROM (
SELECT '20240316' DATEID,'TL' AS CURRENCY_CODE,1.0000 AS TL_EXCHANGE_RATE,36.5555 AS USD_EXCHANGE_RATE
UNION ALL
SELECT '20240316' DATEID,'USD' AS CURRENCY_CODE,0.2500 AS TL_EXCHANGE_RATE,0.0067 AS USD_EXCHANGE_RATE
UNION ALL 
SELECT '20240316' DATEID,'EUR' AS CURRENCY_CODE,39.8222 AS TL_EXCHANGE_RATE,1.0900 AS USD_EXCHANGE_RATE 
UNION ALL
SELECT '20240316' DATEID,'GBP' AS CURRENCY_CODE,47.2222 AS TL_EXCHANGE_RATE,1.2900 AS USD_EXCHANGE_RATE 
UNION ALL
SELECT '20240316' DATEID,'UnknownCurrency' AS CURRENCY_CODE,1.0000 AS TL_EXCHANGE_RATE,1.0000 AS USD_EXCHANGE_RATE 
UNION ALL 
SELECT '20240316' DATEID,'JPY' AS CURRENCY_CODE,0.2500 AS TL_EXCHANGE_RATE,0.0067 AS USD_EXCHANGE_RATE 
) HH 
;
/*
SELECT * FROM DBO.DIM_EXCHANGE_RATE
*/
--USD 11
--EUR 12
--JPY 13
--GBP 14
--UnknownCurrency 15

--""  21
--Equity  22
--Derivatives 23
--Fixed Income 24


--Order Update 31
--Settlement  32
--Trade 33

/*###  4 >>>> DIM_CURRENCY_TYPE ###*/
CREATE TABLE DBO.DIM_CURRENCY_TYPE
(CURRENCY_NO INT,
 CURRENCY_CODE NVARCHAR(20),
 ETL_DATE DATETIME
)
;

INSERT INTO DBO.DIM_CURRENCY_TYPE
SELECT CONCAT('1','',RANK() OVER(ORDER BY HH.CURRENCY_CODE ASC))AS CURRENCY_NO,
      HH.CURRENCY_CODE,
	  GETDATE() ETL_DATE
FROM (
SELECT 'USD' AS CURRENCY_CODE
UNION ALL
SELECT 'EUR' AS CURRENCY_CODE
UNION ALL
SELECT 'JPY' AS CURRENCY_CODE
UNION ALL 
SELECT 'GBP'  AS CURRENCY_CODE
UNION ALL 
SELECT 'UnknownCurrency'  AS CURRENCY_CODE
) HH 
ORDER BY 1
;

/*###  5 >>>> DIM_INSTRUMENT_TYPE ###*/
CREATE TABLE DBO.DIM_INSTRUMENT_TYPE
(INSTRUMENT_TYPE_ID INT,
 INSTRUMENT_TYPE_NAME NVARCHAR(20),
 ETL_DATE DATETIME
)
;
INSERT INTO DBO.DIM_INSTRUMENT_TYPE
SELECT CONCAT('2','',RANK() OVER(ORDER BY HH.INSTRUMENT_TYPE_NAME ASC))AS INSTRUMENT_TYPE_ID,
      HH.INSTRUMENT_TYPE_NAME ,
	  GETDATE() AS ETL_DATE
FROM (
SELECT 'Equity' AS INSTRUMENT_TYPE_NAME
UNION ALL
SELECT 'Fixed Income' AS INSTRUMENT_TYPE_NAME
UNION ALL
SELECT 'Derivatives' AS INSTRUMENT_TYPE_NAME
UNION ALL 
SELECT 'UNKNOWN'  AS INSTRUMENT_TYPE_NAME
) HH 
ORDER BY 1
;
/*###  6 >>>> DIM_TRANSACTION_TYPE ###*/
CREATE TABLE DBO.DIM_TRANSACTION_TYPE
(TRANSACTION_TYPE_ID INT,
 TRANSACTION_TYPE_NAME NVARCHAR(20),
 ETL_DATE DATETIME
)
;

INSERT INTO DBO.DIM_TRANSACTION_TYPE
SELECT CONCAT('3','',RANK() OVER(ORDER BY HH.TRANSACTION_TYPE_NAME ASC))AS TRANSACTION_TYPE_ID,
      HH.TRANSACTION_TYPE_NAME ,
	  GETDATE() AS ETL_DATE
FROM (
SELECT 'Order Update' AS TRANSACTION_TYPE_NAME
UNION ALL
SELECT 'Settlement' AS TRANSACTION_TYPE_NAME
UNION ALL
SELECT 'Trade' AS TRANSACTION_TYPE_NAME
) HH 
ORDER BY 1
;

/*###  7 >>>> DIM_CONTRACT ###*/
/* CONTRACT_NO SURROGATE KEY OLARAK DUSUNULMUSTUR */
CREATE TABLE DBO.DIM_CONTRACT
(CONTRACT_NO INT,
TRANSACTION_TYPE_ID INT,
TRANSACTION_TYPE_NAME NVARCHAR(20),
CURRENCY_NO INT,
CURRENCY_CODE NVARCHAR(20),
INSTRUMENT_TYPE_ID INT,
INSTRUMENT_TYPE_NAME NVARCHAR(20),
ETL_DATE DATETIME)
;

INSERT INTO DBO.DIM_CONTRACT 
SELECT CONCAT(CONCAT(CCC.CURRENCY_NO,'',CCC.INSTRUMENT_TYPE_ID),'',CCC.TRANSACTION_TYPE_ID) AS CONTRACT_KEY,
       CCC.TRANSACTION_TYPE_ID ,
 CCC.TRANSACTION_TYPE_NAME ,
 CCC.CURRENCY_NO ,
 CCC.CURRENCY_CODE ,
 CCC.INSTRUMENT_TYPE_ID,
 CCC.INSTRUMENT_TYPE_NAME ,
 GETDATE() AS ETL_DATE 
FROM (
SELECT DISTINCT DIT.INSTRUMENT_TYPE_ID,
DIT.INSTRUMENT_TYPE_NAME,
DCT.CURRENCY_NO,
DCT.CURRENCY_CODE,
DTT.TRANSACTION_TYPE_ID,
DTT.TRANSACTION_TYPE_NAME
FROM DBO.DIM_INSTRUMENT_TYPE DIT
CROSS JOIN DBO.DIM_CURRENCY_TYPE DCT 
CROSS JOIN DBO.DIM_TRANSACTION_TYPE DTT
) CCC 
ORDER BY 1
;
/* ##KEY COKLAMA  KONTROLU  */
/*
--0--
SELECT CONTRACT_NO,COUNT(1) FROM DBO.DIM_CONTRACT
GROUP BY CONTRACT_NO
HAVING COUNT(1) >1